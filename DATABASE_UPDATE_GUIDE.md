# 数据库更新指南

## 🔄 如何更新客户数据库

### 方法1: 替换数据库文件（推荐）

1. **准备新的数据库文件**
   - 将客户提供的新 `.db` 文件重命名为 `customer-data.db`
   - 确保文件放在 `server/` 目录下

2. **提交并推送**
   ```bash
   git add server/customer-data.db
   git commit -m "更新客户数据库文件"
   git push origin main
   ```

3. **自动迁移**
   - Railway会自动检测到文件变化
   - 系统会自动重新部署并迁移新数据

### 方法2: 使用更新脚本

1. **运行更新脚本**
   ```bash
   node server/update-database.js
   ```

2. **脚本功能**
   - 自动备份现有数据库
   - 检查新数据库文件
   - 执行完整数据迁移
   - 如果失败，自动恢复备份

### 方法3: 手动迁移

1. **停止服务**
   - 在Railway控制台停止服务

2. **更新数据库文件**
   - 替换 `server/customer-data.db`

3. **重新部署**
   - 在Railway控制台重新部署

## 📊 迁移的数据类型

### 基础数据
- ✅ **users** - 用户数据
- ✅ **materials** - 物料数据  
- ✅ **products** - 产品数据
- ✅ **product_aux_mapping** - 产品配方数据

### 业务数据
- ✅ **raw_inout** → **inbound_raw** - 原料入库记录
- ✅ **aux_inout** → **aux_inbound** - 辅料入库记录
- ✅ **product_inbound** - 产品入库记录
- ✅ **product_outbound** - 产品出库记录
- ✅ **raw_out** → **outbound_raw** - 原料出库记录
- ✅ **aux_outbound** - 辅料出库记录
- ✅ **stock** - 库存数据
- ✅ **assets** - 资产数据

## 🔍 验证更新

### 检查迁移结果
1. **查看Railway日志** - 确认迁移成功
2. **检查数据统计** - 验证数据数量
3. **测试API接口** - 确保数据可访问

### 预期日志输出
```
📦 开始完整数据迁移...
👥 迁移用户数据...
   ✅ 迁移了 X 个用户
📦 迁移物料数据...
   ✅ 迁移了 X 个物料
🏭 迁移产品数据...
   ✅ 迁移了 X 个产品
🔗 迁移产品配方数据...
   ✅ 迁移了 X 个产品配方
📥 迁移原料入库数据...
   ✅ 迁移了 X 条原料入库记录
📥 迁移辅料入库数据...
   ✅ 迁移了 X 条辅料入库记录
📥 迁移产品入库数据...
   ✅ 迁移了 X 条产品入库记录
📤 迁移产品出库数据...
   ✅ 迁移了 X 条产品出库记录
📤 迁移原料出库数据...
   ✅ 迁移了 X 条原料出库记录
📤 迁移辅料出库数据...
   ✅ 迁移了 X 条辅料出库记录
📊 迁移库存数据...
   ✅ 迁移了 X 条库存记录
🏢 迁移资产数据...
   ✅ 迁移了 X 条资产记录
```

## ⚠️ 注意事项

1. **备份重要** - 更新前会自动备份现有数据库
2. **文件命名** - 新数据库文件必须命名为 `customer-data.db`
3. **文件位置** - 必须放在 `server/` 目录下
4. **数据冲突** - 如果数据已存在，会更新而不是重复插入
5. **错误处理** - 如果迁移失败，会自动恢复备份

## 🚀 快速更新步骤

1. **替换文件**: 将新 `.db` 文件重命名为 `customer-data.db` 并放在 `server/` 目录
2. **提交代码**: `git add . && git commit -m "更新数据库" && git push`
3. **等待部署**: Railway会自动重新部署并迁移数据
4. **验证结果**: 检查Railway日志确认迁移成功

## 📞 支持

如果遇到问题，请检查：
- 数据库文件是否正确命名和放置
- Railway日志中的错误信息
- 数据迁移统计信息
